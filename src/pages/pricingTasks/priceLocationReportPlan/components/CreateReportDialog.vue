<template>
    <t-dialog header="创建采价点上报计划" :visible.sync="visible" :destroyOnClose="true" :closeOnOverlayClick="false"
        @close="onClose" width="1200px" top="5%" class="create-report-dialog">
        <div class="dialog-content">
            <div class="form-container">
                <t-form ref="taskForm" :data="formData" label-width="110px">
                    <t-row :gutter="[16, 24]" :style="{ marginBottom: '10px' }">
                        <t-col :span="3">
                            <t-form-item label="行政区划" name="areaCodes">
                                <t-tree-select v-model="formData.areaCodes" filterable placeholder="请选择" clearable
                                    multiple :data="areaList" :treeProps="treeProps" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="采价点类型" name="pointType">
                                <t-select v-model="formData.pointType" placeholder="请选择" clearable multiple
                                    :options="pointTypeOptions" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="采价点归属" name="pointAffiliation">
                                <t-select v-model="formData.pointAffiliation" placeholder="请选择" clearable multiple
                                    :options="pointAffiliationOptions" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="采价点客户标识" name="customerType">
                                <t-select v-model="formData.customerType" placeholder="请选择" clearable multiple
                                    :options="customerIdentifierOptions" />
                            </t-form-item>
                        </t-col>
                    </t-row>

                    <t-row :gutter="[16, 24]" :style="{ marginBottom: '10px' }">
                        <t-col :span="3">
                            <t-form-item label="品种" name="varietyId">
                                <t-select v-model="formData.varietyId" placeholder="请选择" clearable
                                    :options="varietyOptions" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="计划周期" name="planPeriod">
                                <t-date-range-picker v-model="formData.planPeriod" value-type="YYYY-MM-DD"
                                    placeholder="起始-止期" :disableDate="disablePastDates" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="上报周期(天)" name="reportPeriod">
                                <t-input v-model="formData.reportPeriod" placeholder="输入正整数" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <t-form-item label="发送短信提醒" name="sendSms">
                                <t-select v-model="formData.sendSms" :options="smsReminderOptions">
                                </t-select>
                            </t-form-item>
                        </t-col>
                    </t-row>

                    <t-row :gutter="[16, 24]" :style="{ marginBottom: '10px' }">
                        <t-col :span="6">
                            <t-form-item label="选择采价点" name="selectedPoints">
                                <t-select v-model="formData.selectedPoints" placeholder="请选择采价点" multiple
                                    :options="pointOptions" />
                            </t-form-item>
                        </t-col>
                        <t-col :span="3">
                            <div class="action-buttons">
                                <t-button theme="default" @click="onClose">取消</t-button>
                                <t-button theme="success" @click="onPreview" style="margin-left: 8px">预览任务</t-button>
                            </div>
                        </t-col>
                    </t-row>
                </t-form>
            </div>

            <t-divider />

            <div class="preview-section">
                <div class="preview-title">上报预览</div>
                <div class="preview-container">
                    <!-- 左侧日历选择面板 -->
                    <div class="calendar-panel">
                        <t-calendar v-if="showCalendarPreview" theme="card" multiple :value="highlightedDates" />
                        <div v-else class="empty-calendar">
                            <div class="placeholder-text">点击"预览任务"查看日历预览</div>
                        </div>
                    </div>

                    <!-- 右侧采价任务部分 -->
                    <div class="task-preview" v-if="showPreview">
                        <div class="task-preview-title">上报计划</div>
                        <div class="task-info">
                            <span>计划周期: {{ formatDateRange(formData.planPeriod) }}</span>
                            <span class="task-info-item">上报周期: {{ formData.reportPeriod }}天</span>
                            <span class="task-info-item">次数: {{ taskCount }}</span>
                        </div>
                        <div class="task-preview-content">
                            <t-loading :loading="previewLoading" text="加载预览数据...">
                                <t-table :data="previewData" :columns="previewColumns" bordered size="small"
                                    row-key="id">
                                    <template #district="{ row }">
                                        {{ row.district }}
                                    </template>
                                    <template #pointName="{ row }">
                                        {{ row.pointName }}
                                    </template>
                                </t-table>
                            </t-loading>
                        </div>
                    </div>
                    <div class="empty-preview" v-else>
                        <div class="placeholder-text">点击"预览任务"查看上报计划详情</div>
                    </div>
                </div>
            </div>
        </div>

        <template #footer>
            <div class="dialog-footer">
                <t-button theme="primary" @click="onConfirm">确定创建</t-button>
            </div>
        </template>
    </t-dialog>
</template>

<script lang="ts">
import Vue from 'vue';
import dayjs from 'dayjs';

export default Vue.extend({
    name: 'CreateReportDialog',
    props: {
        visible: {
            type: Boolean,
            default: false,
        },
    },
    data() {
        return {
            previewLoading: false,
            highlightedDates: [],
            // 存储初始表单数据，用于重置
            initialFormData: {
                areaCodes: [],
                pointType: [],
                pointAffiliation: [],
                customerType: [],
                varietyId: '',
                planPeriod: [],
                reportPeriod: 2,
                selectedPoints: [],
                sendSms: true,
            },
            formData: {
                areaCodes: [],
                pointType: [],
                pointAffiliation: [],
                customerType: [],
                varietyId: '',
                planPeriod: [],
                reportPeriod: 2,
                selectedPoints: [],
                sendSms: true,
            },
            // 树形控件属性
            treeProps: {
                keys: {
                    label: 'areaname',
                    value: 'areacode',
                    children: 'children',
                }
            },
            // 表单选项数据
            areaList: [],
            pointTypeOptions: [],
            pointAffiliationOptions: [],
            customerIdentifierOptions: [
                { label: '客户', value: '1' },
                { label: '非客户', value: '0' },
            ],
            varietyOptions: [],
            pointOptions: [],
            smsReminderOptions: [
                { label: '是', value: true },
                { label: '否', value: false },
            ],
            showPreview: false, // 控制是否显示预览数据
            showCalendarPreview: false, // 控制是否显示日历预览
            previewColumns: [
                { colKey: 'district', title: '行政区划', width: '200' },
                { colKey: 'pointName', title: '采价点', width: '250' },
            ],
            previewData: [], // 实际显示的预览数据
            taskCount: 0, // 任务次数
        };
    },
    watch: {
        // 监听弹窗可见性变化
        visible(newVal) {
            if (newVal) {
                this.initFormData();
            }
        },
        // 监听行政区划变化
        'formData.areaCodes': function (newVal) {
            this.getPointOptions();
        },
        // 监听采价点归属变化
        'formData.pointAffiliation': function (newVal) {
            this.getPointOptions();
        },
        // 监听采价点类型变化
        'formData.pointType': function (newVal) {
            this.getPointOptions();
        },
    },
    methods: {
        // 初始化表单数据和下拉选项
        initFormData() {
            // 重置表单为初始状态
            this.resetForm();

            // 获取下拉选项数据
            this.getAreaList();
            this.getPointTypeOptions();
            this.getPointAffiliationOptions();
            this.getVarietyOptions();
            this.getPointOptions();
        },

        formatDateRange(dateRange) {
            if (!dateRange || dateRange.length !== 2) return '';
            return `${dateRange[0]} 至 ${dateRange[1]}`;
        },

        disablePastDates(date) {
            // 禁用今天之前的日期
            return date < new Date(new Date().setHours(0, 0, 0, 0));
        },

        // 重置表单和预览状态
        resetForm() {
            // 深拷贝初始表单数据
            this.formData = JSON.parse(JSON.stringify(this.initialFormData));
            this.showPreview = false;
            this.showCalendarPreview = false;
            this.highlightedDates = [];
            this.previewData = [];
            this.taskCount = 0;
        },

        onClose() {
            // 重置表单和预览状态
            this.resetForm();
            this.$emit('close');
        },

        // 生成高亮日期
        generateHighlightedDates() {
            const [startDateStr, endDateStr] = this.formData.planPeriod;
            const reportPeriod = parseInt(this.formData.reportPeriod, 10);

            if (!startDateStr || !endDateStr || isNaN(reportPeriod) || reportPeriod <= 0) {
                return [];
            }

            const startDate = dayjs(startDateStr);
            const endDate = dayjs(endDateStr);
            const dates = [];
            let currentDate = startDate;

            // 计算任务次数
            this.taskCount = Math.floor(endDate.diff(startDate, 'day') / reportPeriod) + 1;

            // 生成每隔reportPeriod天的日期
            while (currentDate.isSame(endDate) || currentDate.isBefore(endDate)) {
                dates.push(currentDate.format('YYYY-MM-DD'));
                currentDate = currentDate.add(reportPeriod, 'day');
            }

            return dates;
        },

        // 预览任务
        onPreview() {
            // 验证必填字段
            const requiredFields = ['areaCodes', 'pointType', 'pointAffiliation', 'customerType', 'varietyId', 'planPeriod', 'reportPeriod', 'selectedPoints'];

            // 验证字段是否都已填写
            const missingFields = requiredFields.filter(field => {
                const value = this.formData[field];
                if (Array.isArray(value)) {
                    return value.length === 0;
                }
                return value === '' || value === null || value === undefined;
            });

            if (missingFields.length > 0) {
                // 构建字段映射表
                const fieldNameMap = {
                    areaCodes: '行政区划',
                    pointType: '采价点类型',
                    pointAffiliation: '采价点归属',
                    customerType: '采价点客户标识',
                    varietyId: '品种',
                    planPeriod: '计划周期',
                    reportPeriod: '上报周期',
                    selectedPoints: '选择采价点'
                };

                // 获取缺失字段的名称
                const missingFieldNames = missingFields.map(field => fieldNameMap[field]);

                this.$message.warning(`请填写必填项: ${missingFieldNames.join(', ')}`);
                return;
            }

            // 验证上报周期是否为正整数
            const reportPeriod = parseInt(this.formData.reportPeriod, 10);
            if (isNaN(reportPeriod) || reportPeriod <= 0) {
                this.$message.warning('上报周期必须是正整数');
                return;
            }

            // 加载状态
            this.showPreview = true;
            this.showCalendarPreview = false;
            this.previewLoading = true;

            const apiParams = {
                condition: {
                    // 基础参数
                    areaCodes: this.formData.areaCodes,
                    stallType: this.formData.pointType,
                    stallVest: this.formData.pointAffiliation,
                    customerIdentification: this.formData.customerType,
                    varietyId: parseInt(this.formData.varietyId, 10),

                    // 日期参数
                    planBgnDate: this.formData.planPeriod[0],
                    planEndDate: this.formData.planPeriod[1],

                    // 周期参数
                    reportCycle: parseInt(this.formData.reportPeriod, 10),

                    // 转换为1-0
                    isSmsMessages: this.formData.sendSms ? "1" : "0",

                    // 采价点
                    stallId: this.formData.selectedPoints,
                }
            };

            console.log('预览参数:', apiParams);

            this.$request
                .post('/web/reportPlan/previewReportPlan', apiParams)
                .then((res) => {
                    if (res.retCode === 200) {
                        const previewData = res.retData;
                        this.taskCount = previewData.frequency || 0;

                        this.previewData = (previewData.previews || []).map((item, index) => ({
                            id: index + 1,
                            district: item.areaname || '',
                            pointName: item.stallName || ''
                        }));

                        // 生成高亮日期
                        this.highlightedDates = this.generateHighlightedDates();
                        this.showCalendarPreview = true;

                        // 如果没有数据就显示提示
                        if (this.previewData.length === 0) {
                            this.$message.info('没有符合条件的预览数据');
                        }
                    } else {
                        this.$message.error(res.retMsg || '获取预览数据失败');
                        this.showPreview = false;
                        this.showCalendarPreview = false;
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取预览数据失败');
                    this.showPreview = false;
                    this.showCalendarPreview = false;
                })
                .finally(() => {
                    this.previewLoading = false;
                });
        },

        onConfirm() {
            const requiredFields = ['areaCodes', 'pointType', 'pointAffiliation', 'customerType', 'varietyId', 'planPeriod', 'reportPeriod', 'selectedPoints'];

            const missingFields = requiredFields.filter(field => {
                const value = this.formData[field];
                if (Array.isArray(value)) {
                    return value.length === 0;
                }
                return value === '' || value === null || value === undefined;
            });

            if (missingFields.length > 0) {
                const fieldNameMap = {
                    areaCodes: '行政区划',
                    pointType: '采价点类型',
                    pointAffiliation: '采价点归属',
                    customerType: '采价点客户标识',
                    varietyId: '品种',
                    planPeriod: '计划周期',
                    reportPeriod: '上报周期',
                    selectedPoints: '选择采价点'
                };

                const missingFieldNames = missingFields.map(field => fieldNameMap[field]);

                this.$message.warning(`请填写必填项: ${missingFieldNames.join(', ')}`);
                return;
            }

            // 验证上报周期是否为正整数
            const reportPeriod = parseInt(this.formData.reportPeriod, 10);
            if (isNaN(reportPeriod) || reportPeriod <= 0) {
                this.$message.warning('上报周期必须是正整数');
                return;
            }

            const apiParams = {
                condition: {
                    areaCodes: this.formData.areaCodes,
                    stallType: this.formData.pointType,
                    stallVest: this.formData.pointAffiliation,
                    customerIdentification: this.formData.customerType,
                    varietyId: parseInt(this.formData.varietyId, 10),
                    planBgnDate: this.formData.planPeriod[0],
                    planEndDate: this.formData.planPeriod[1],
                    reportCycle: parseInt(this.formData.reportPeriod, 10),
                    isSmsMessages: this.formData.sendSms ? "1" : "0",
                    stallId: this.formData.selectedPoints,
                }
            };

            console.log('提交参数:', apiParams);

            this.$request
                .post('/web/reportPlan/saveReportPlan', apiParams)
                .then((res) => {
                    if (res.retCode === 200) {
                        this.$message.success('创建上报计划成功');
                        this.$emit('confirm', this.formData);
                        this.onClose();
                    } else {
                        this.$message.error(res.retMsg || '创建上报计划失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('创建上报计划失败');
                });
        },

        getAreaList() {
            this.$request
                .post('/web/area/selectUserDataAreaTree')
                .then((res) => {
                    if (res.retCode === 200) {
                        this.areaList = res.retData || [];
                    } else {
                        this.$message.error(res.retMsg || '获取行政区划数据失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取行政区划数据失败');
                });
        },

        getPointTypeOptions() {
            const params = {
                condition: {
                    dictType: 'STALL_TYPE',
                },
            };

            this.$request
                .post('/web/dict/queryTypeDicts', params)
                .then((res) => {
                    if (res.retCode === 200) {
                        this.pointTypeOptions = [];

                        if (res.retData && res.retData.length > 0) {
                            const options = res.retData.map((item) => ({
                                label: item.dictValue,
                                value: item.dictCode,
                            }));

                            this.pointTypeOptions = [...this.pointTypeOptions, ...options];
                        }
                    } else {
                        this.$message.error(res.retMsg || '获取采价点类型失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取采价点类型失败');
                });
        },

        getPointAffiliationOptions() {
            const params = {
                condition: {
                    dictType: 'VEST_TYPE',
                },
            };

            this.$request
                .post('/web/dict/queryTypeDicts', params)
                .then((res) => {
                    if (res.retCode === 200) {
                        this.pointAffiliationOptions = [];

                        if (res.retData && res.retData.length > 0) {
                            const options = res.retData.map((item) => ({
                                label: item.dictValue,
                                value: item.dictCode,
                            }));

                            this.pointAffiliationOptions = [...this.pointAffiliationOptions, ...options];
                        }
                    } else {
                        this.$message.error(res.retMsg || '获取采价点归属失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取采价点归属失败');
                });
        },

        getPointOptions() {
            const params = {
                condition: {
                    stallTypes: this.formData.pointType || [],
                    stallVests: this.formData.pointAffiliation || [],
                    areacodes: this.formData.areaCodes || [],
                },
            };

            this.$request
                .post('/web/stall/selectChooseStalls2', params)
                .then((res) => {
                    if (res.retCode === 200) {
                        this.pointOptions = [];

                        if (res.retData && res.retData.length > 0) {
                            const options = res.retData.map((item) => ({
                                label: item.stallName,
                                value: item.stallId,
                            }));

                            this.pointOptions = [...this.pointOptions, ...options];
                        }

                        // 如果有当前选中的采价点在新的选项中不存在，则过滤掉这些采价点
                        if (this.formData.selectedPoints && this.formData.selectedPoints.length > 0) {
                            const validOptions = this.pointOptions.map(option => option.value);
                            this.formData.selectedPoints = this.formData.selectedPoints.filter(point =>
                                validOptions.includes(point)
                            );
                        }
                    } else {
                        this.$message.error(res.retMsg || '获取采价点数据失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取采价点数据失败');
                });
        },

        getVarietyOptions() {
            this.$request
                .post('/web/variety/selectButtomVarieties')
                .then((res) => {
                    if (res.retCode === 200) {
                        this.varietyOptions = [];

                        if (res.retData && res.retData.length > 0) {
                            const options = res.retData.map((item) => ({
                                label: item.varietyName,
                                value: item.varietyId,
                            }));

                            this.varietyOptions = [...this.varietyOptions, ...options];
                        }
                    } else {
                        this.$message.error(res.retMsg || '获取品种失败');
                    }
                })
                .catch((e) => {
                    console.error(e);
                    this.$message.error('获取品种失败');
                });
        },
    }
});
</script>

<style lang="less" scoped>
.create-report-dialog {
    :deep(.t-dialog__header) {
        font-weight: bold;
    }

    .dialog-content {
        padding: 0 20px;
    }

    .form-container {
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        justify-content: flex-start;
        align-items: flex-end;
        height: 100%;
        padding-bottom: 4px;
    }

    .preview-section {
        margin-top: 20px;
        margin-bottom: 20px;

        .preview-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 16px;
        }
    }

    .preview-container {
        display: flex;
        gap: 20px;
        height: 400px; // 固定高度

        .calendar-panel {
            flex: 0 0 33%;
            height: 100%; // 设置高度占满父容器

            :deep(.t-calendar) {
                border: 1px solid #e7e7e7;
                border-radius: 4px;
                box-shadow: none;
                width: 100%;
                height: 100%;
            }

            .empty-calendar {
                border: 1px solid #e7e7e7;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #f9f9f9;
                height: 100%;

                .placeholder-text {
                    color: #999;
                    font-size: 14px;
                }
            }
        }

        .task-preview {
            flex: 0 0 65%;
            border: 1px solid #e7e7e7;
            border-radius: 4px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: 100%;

            .task-preview-title {
                font-weight: bold;
                margin-bottom: 16px;
            }

            .task-info {
                margin-bottom: 16px;

                .task-info-item {
                    margin-left: 20px;
                }
            }

            .task-preview-content {
                flex: 1;
                overflow-y: auto; // 添加垂直滚动条

                // 美化滚动条
                &::-webkit-scrollbar {
                    width: 6px;
                }

                &::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 3px;
                }

                &::-webkit-scrollbar-thumb {
                    background: #c0c0c0;
                    border-radius: 3px;
                }

                &::-webkit-scrollbar-thumb:hover {
                    background: #a0a0a0;
                }
            }
        }

        .empty-preview {
            flex: 0 0 65%;
            border: 1px solid #e7e7e7;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            height: 100%;

            .placeholder-text {
                color: #999;
                font-size: 14px;
            }
        }
    }

    .dialog-footer {
        display: flex;
        justify-content: center;
    }
}
</style>